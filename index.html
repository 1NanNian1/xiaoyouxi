<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>冒险大作战</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3B82F6',
                        secondary: '#10B981',
                        accent: '#F59E0B',
                        danger: '#EF4444',
                        dark: '#1F2937',
                        light: '#F3F4F6'
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .text-shadow {
                text-shadow: 0 2px 4px rgba(0,0,0,0.1);
            }
            .text-shadow-lg {
                text-shadow: 0 4px 8px rgba(0,0,0,0.25);
            }
            .animate-pulse-slow {
                animation: pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite;
            }
            .animate-float {
                animation: float 3s ease-in-out infinite;
            }
            @keyframes float {
                0%, 100% {
                    transform: translateY(0);
                }
                50% {
                    transform: translateY(-10px);
                }
            }
            .joystick-dot {
                transition: transform 0.1s;
            }
            .weapon-badge {
                @apply absolute -top-2 -right-2 bg-danger text-white text-xs font-bold rounded-full w-5 h-5 flex items-center justify-center;
            }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-900 to-purple-800 min-h-screen overflow-hidden font-sans text-light">
    <!-- 游戏容器 -->
    <div id="game-container" class="relative w-full h-screen flex flex-col items-center justify-center">
        <!-- 游戏开始界面 -->
        <div id="start-screen" class="absolute inset-0 flex flex-col items-center justify-center bg-dark/90 backdrop-blur-sm z-50">
            <h1 class="text-[clamp(2rem,8vw,3.5rem)] font-bold text-primary mb-6 animate-float">冒险大作战</h1>
            <p class="text-[clamp(1rem,3vw,1.25rem)] text-gray-300 mb-10 max-w-md px-4 text-center">控制角色收集技能牌，击败敌人，升级武器，挑战更多波次！</p>
            
            <div class="bg-dark/50 backdrop-blur-md rounded-xl p-6 mb-8 shadow-lg w-full max-w-md">
                <h3 class="text-xl font-semibold mb-4 text-center">初始武器选择</h3>
                <div class="grid grid-cols-3 gap-3">
                    <button class="weapon-btn p-2 rounded-lg border-2 border-primary bg-primary/20" data-weapon="pistol">
                        <i class="fa-solid fa-handgun text-2xl mx-auto"></i>
                        <p class="text-xs mt-1 text-center">手枪</p>
                    </button>
                    <button class="weapon-btn p-2 rounded-lg border-2 border-transparent" data-weapon="bow">
                        <i class="fa-solid fa-bow text-2xl mx-auto"></i>
                        <p class="text-xs mt-1 text-center">弓箭</p>
                    </button>
                    <button class="weapon-btn p-2 rounded-lg border-2 border-transparent" data-weapon="rifle">
                        <i class="fa-solid fa-rifle text-2xl mx-auto"></i>
                        <p class="text-xs mt-1 text-center">步枪</p>
                    </button>
                </div>
            </div>
            
            <button id="start-game-btn" class="bg-primary hover:bg-primary/90 text-white font-bold py-4 px-8 rounded-full text-lg shadow-lg transform transition-all duration-300 hover:scale-105 active:scale-95 mb-6">
                <i class="fa-solid fa-play mr-2"></i>开始游戏
            </button>
            
            <div class="bg-dark/50 backdrop-blur-md rounded-lg p-4 w-full max-w-md">
                <h3 class="text-sm font-semibold mb-2 text-center">操作说明</h3>
                <div class="flex flex-col md:flex-row justify-between items-center">
                    <div class="flex flex-col items-center mb-3 md:mb-0">
                        <div class="w-16 h-16 bg-dark/80 rounded-full flex items-center justify-center mb-2">
                            <i class="fa-solid fa-joystick text-2xl text-primary"></i>
                        </div>
                        <span class="text-xs">虚拟摇杆移动</span>
                    </div>
                    <div class="flex flex-col items-center mb-3 md:mb-0">
                        <div class="w-16 h-16 bg-dark/80 rounded-full flex items-center justify-center mb-2">
                            <i class="fa-solid fa-hand-pointer text-2xl text-secondary"></i>
                        </div>
                        <span class="text-xs">点击使用技能</span>
                    </div>
                    <div class="flex flex-col items-center">
                        <div class="w-16 h-16 bg-dark/80 rounded-full flex items-center justify-center mb-2">
                            <i class="fa-solid fa-shield-alt text-2xl text-accent"></i>
                        </div>
                        <span class="text-xs">升级武器技能</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- 游戏界面 -->
        <div id="game-screen" class="absolute inset-0 hidden">
            <!-- 游戏画布 -->
            <canvas id="game-canvas" class="w-full h-full"></canvas>
            
            <!-- 游戏UI元素 -->
            <div class="absolute top-4 left-4 z-10">
                <div class="bg-dark/70 backdrop-blur-md rounded-lg p-2 shadow-lg">
                    <div class="flex items-center space-x-2">
                        <i class="fa-solid fa-wave-square text-accent"></i>
                        <span id="wave-display" class="font-bold">波次: 1</span>
                    </div>
                </div>
            </div>
            
            <div class="absolute top-4 right-4 z-10">
                <div class="bg-dark/70 backdrop-blur-md rounded-lg p-2 shadow-lg">
                    <div class="flex items-center space-x-2">
                        <i class="fa-solid fa-coins text-primary"></i>
                        <span id="coins-display" class="font-bold">金币: 0</span>
                    </div>
                </div>
            </div>
            
            <!-- 虚拟摇杆 -->
            <div id="joystick-container" class="absolute bottom-20 left-4 z-20 bg-dark/50 backdrop-blur-md rounded-full w-32 h-32 shadow-lg p-2">
                <div id="joystick" class="w-full h-full rounded-full bg-dark/80 flex items-center justify-center">
                    <div id="joystick-dot" class="w-12 h-12 rounded-full bg-primary/80 joystick-dot"></div>
                </div>
            </div>
            
            <!-- 技能按钮 -->
            <div id="skills-container" class="absolute bottom-20 right-4 z-20 grid grid-cols-2 gap-2">
                <button id="skill-1" class="w-16 h-16 bg-dark/50 backdrop-blur-md rounded-full shadow-lg flex items-center justify-center skill-btn" data-skill="speed">
                    <i class="fa-solid fa-bolt text-2xl text-yellow-400"></i>
                </button>
                <button id="skill-2" class="w-16 h-16 bg-dark/50 backdrop-blur-md rounded-full shadow-lg flex items-center justify-center skill-btn" data-skill="heal">
                    <i class="fa-solid fa-heart text-2xl text-green-400"></i>
                </button>
            </div>
            
            <!-- 武器显示 -->
            <div id="weapon-display" class="absolute top-4 right-1/2 transform translate-x-1/2 z-10">
                <div class="bg-dark/70 backdrop-blur-md rounded-lg p-2 shadow-lg flex items-center space-x-2">
                    <i id="weapon-icon" class="fa-solid fa-handgun text-2xl text-primary"></i>
                    <div>
                        <span id="weapon-name" class="font-bold">手枪</span>
                        <span id="weapon-level" class="text-xs bg-dark/50 px-1.5 py-0.5 rounded">LV.1</span>
                    </div>
                </div>
            </div>
            
            <!-- 升级按钮 -->
            <button id="upgrade-btn" class="absolute bottom-4 right-4 z-20 bg-accent hover:bg-accent/90 text-dark font-bold py-3 px-6 rounded-full shadow-lg transform transition-all duration-300 hover:scale-105 active:scale-95">
                <i class="fa-solid fa-up-right-and-down-left-from-center mr-2"></i>升级
            </button>
        </div>

        <!-- 升级界面 -->
        <div id="upgrade-screen" class="absolute inset-0 hidden bg-dark/80 backdrop-blur-sm z-40">
            <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-dark rounded-2xl shadow-2xl p-6 w-full max-w-2xl">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-primary">武器升级</h2>
                    <button id="close-upgrade" class="text-gray-400 hover:text-white">
                        <i class="fa-solid fa-xmark text-xl"></i>
                    </button>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <!-- 武器升级 -->
                    <div class="bg-dark/50 rounded-xl p-4 border border-gray-700">
                        <h3 class="text-lg font-semibold mb-3 flex items-center">
                            <i id="upgrade-weapon-icon" class="fa-solid fa-handgun text-primary mr-2"></i>
                            武器升级
                        </h3>
                        <p class="text-sm text-gray-400 mb-4">提升武器伤害和射速</p>
                        <div class="flex justify-between items-center mb-3">
                            <span>当前等级: <span id="current-weapon-level">1</span></span>
                            <span>所需金币: <span id="weapon-upgrade-cost">50</span></span>
                        </div>
                        <button id="upgrade-weapon" class="w-full bg-primary/20 hover:bg-primary/30 text-primary font-medium py-2 rounded-lg disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                            升级
                        </button>
                    </div>
                    
                    <!-- 技能升级 -->
                    <div class="bg-dark/50 rounded-xl p-4 border border-gray-700">
                        <h3 class="text-lg font-semibold mb-3 flex items-center">
                            <i class="fa-solid fa-bolt text-yellow-400 mr-2"></i>
                            技能升级
                        </h3>
                        <p class="text-sm text-gray-400 mb-4">减少技能冷却时间</p>
                        <div class="flex justify-between items-center mb-3">
                            <span>当前等级: <span id="current-skill-level">1</span></span>
                            <span>所需金币: <span id="skill-upgrade-cost">30</span></span>
                        </div>
                        <button id="upgrade-skill" class="w-full bg-primary/20 hover:bg-primary/30 text-primary font-medium py-2 rounded-lg disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                            升级
                        </button>
                    </div>
                    
                    <!-- 角色升级 -->
                    <div class="bg-dark/50 rounded-xl p-4 border border-gray-700">
                        <h3 class="text-lg font-semibold mb-3 flex items-center">
                            <i class="fa-solid fa-shield-alt text-accent mr-2"></i>
                            角色升级
                        </h3>
                        <p class="text-sm text-gray-400 mb-4">提升角色生命值和移动速度</p>
                        <div class="flex justify-between items-center mb-3">
                            <span>当前等级: <span id="current-character-level">1</span></span>
                            <span>所需金币: <span id="character-upgrade-cost">40</span></span>
                        </div>
                        <button id="upgrade-character" class="w-full bg-primary/20 hover:bg-primary/30 text-primary font-medium py-2 rounded-lg disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                            升级
                        </button>
                    </div>
                </div>
                
                <div class="text-center">
                    <p class="text-sm text-gray-400 mb-2">当前金币: <span id="current-coins" class="font-bold text-primary">0</span></p>
                </div>
            </div>
        </div>

        <!-- 游戏结束界面 -->
        <div id="game-over-screen" class="absolute inset-0 hidden flex-col items-center justify-center bg-dark/90 backdrop-blur-sm z-50">
            <div class="bg-dark rounded-2xl shadow-2xl p-8 max-w-md w-full mx-4 transform transition-all duration-500 scale-95 opacity-0" id="game-over-card">
                <h2 class="text-3xl font-bold text-center text-primary mb-2">游戏结束</h2>
                <p class="text-center text-gray-400 mb-6">你坚持到了 <span id="final-wave" class="font-bold text-accent">1</span> 波</p>
                
                <div class="bg-dark/50 rounded-xl p-4 mb-6">
                    <div class="flex justify-between items-center mb-3">
                        <span class="text-gray-400">最终得分</span>
                        <span id="final-score" class="text-2xl font-bold text-secondary">0</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-400">最高得分</span>
                        <span id="high-score" class="text-2xl font-bold text-primary">0</span>
                    </div>
                </div>
                
                <button id="restart-game-btn" class="w-full bg-primary hover:bg-primary/90 text-white font-bold py-3 px-6 rounded-lg shadow transform transition-all duration-300 hover:scale-105 active:scale-95">
                    <i class="fa-solid fa-refresh mr-2"></i>重新开始
                </button>
            </div>
        </div>
    </div>

    <script>
        // 游戏常量
        const GAME_WIDTH = window.innerWidth;
        const GAME_HEIGHT = window.innerHeight;
        const CHARACTER_SIZE = Math.min(GAME_WIDTH * 0.08, 60); // 角色大小
        const ENEMY_MIN_SIZE = Math.min(GAME_WIDTH * 0.06, 40); // 敌人最小大小
        const ENEMY_MAX_SIZE = Math.min(GAME_WIDTH * 0.1, 60); // 敌人最大大小
        const SKILL_SIZE = Math.min(GAME_WIDTH * 0.07, 50); // 技能牌大小
        const BULLET_SIZE = Math.min(GAME_WIDTH * 0.03, 20); // 子弹大小
        const WAVE_INTERVAL = 15000; // 波次间隔15秒
        const ENEMY_SPAWN_INTERVAL = 1000; // 敌人生成间隔1秒
        
        // 游戏状态
        let gameState = 'start'; // start, playing, gameOver, upgrade
        let currentWave = 1; // 当前波次
        let score = 0; // 得分
        let highScore = localStorage.getItem('adventureHighScore') || 0; // 最高分
        let coins = 0; // 金币
        let isPaused = false; // 游戏暂停状态
        
        // 角色状态
        let character = {
            x: GAME_WIDTH / 2,
            y: GAME_HEIGHT / 2,
            width: CHARACTER_SIZE,
            height: CHARACTER_SIZE,
            speed: 5, // 移动速度
            health: 100, // 生命值
            maxHealth: 100, // 最大生命值
            direction: { x: 0, y: 0 }, // 移动方向
            weapon: 'pistol', // 当前武器
            weaponLevel: 1, // 武器等级
            skillCooldown: {
                speed: 0, // 速度技能冷却
                heal: 0 // 治疗技能冷却
            },
            skillLevel: 1, // 技能等级
            characterLevel: 1, // 角色等级
            canShoot: true // 能否射击
        };
        
        // 武器数据
        const weapons = {
            pistol: {
                name: "手枪",
                icon: "fa-handgun",
                damage: 10, // 基础伤害
                fireRate: 1000, // 射击间隔(毫秒)
                bulletSpeed: 10, // 子弹速度
                bulletColor: "#3B82F6", // 子弹颜色
                unlockCost: 0, // 解锁价格
                upgradeCost: [50, 100, 150, 200], // 升级价格
                upgradeDamage: [10, 15, 20, 25], // 升级后伤害
                upgradeFireRate: [1000, 800, 600, 400], // 升级后射击间隔
                isUnlocked: true // 是否已解锁
            },
            bow: {
                name: "弓箭",
                icon: "fa-bow",
                damage: 15,
                fireRate: 1500,
                bulletSpeed: 8,
                bulletColor: "#10B981",
                unlockCost: 100,
                upgradeCost: [70, 140, 210, 280],
                upgradeDamage: [15, 25, 35, 45],
                upgradeFireRate: [1500, 1200, 900, 600],
                isUnlocked: false
            },
            rifle: {
                name: "步枪",
                icon: "fa-rifle",
                damage: 8,
                fireRate: 500,
                bulletSpeed: 15,
                bulletColor: "#F59E0B",
                unlockCost: 200,
                upgradeCost: [60, 120, 180, 240],
                upgradeDamage: [8, 12, 16, 20],
                upgradeFireRate: [500, 400, 300, 200],
                isUnlocked: false
            },
            flamethrower: {
                name: "喷火器",
                icon: "fa-fire",
                damage: 5,
                fireRate: 200,
                bulletSpeed: 3,
                bulletColor: "#EF4444",
                unlockCost: 300,
                upgradeCost: [80, 160, 240, 320],
                upgradeDamage: [5, 8, 11, 14],
                upgradeFireRate: [200, 150, 100, 50],
                isUnlocked: false
            },
            lightning: {
                name: "雷电",
                icon: "fa-bolt",
                damage: 25,
                fireRate: 2000,
                bulletSpeed: 20,
                bulletColor: "#F59E0B",
                unlockCost: 400,
                upgradeCost: [100, 200, 300, 400],
                upgradeDamage: [25, 40, 55, 70],
                upgradeFireRate: [2000, 1500, 1000, 500],
                isUnlocked: false
            },
            windwheel: {
                name: "风火轮",
                icon: "fa-wind",
                damage: 12,
                fireRate: 1200,
                bulletSpeed: 12,
                bulletColor: "#8B5CF6",
                unlockCost: 500,
                upgradeCost: [120, 240, 360, 480],
                upgradeDamage: [12, 20, 28, 36],
                upgradeFireRate: [1200, 1000, 800, 600],
                isUnlocked: false
            },
            dart: {
                name: "飞镖",
                icon: "fa-dart",
                damage: 18,
                fireRate: 1800,
                bulletSpeed: 18,
                bulletColor: "#10B981",
                unlockCost: 600,
                upgradeCost: [90, 180, 270, 360],
                upgradeDamage: [18, 28, 38, 48],
                upgradeFireRate: [1800, 1500, 1200, 900],
                isUnlocked: false
            }
        };
        
        // 当前使用的武器
        let currentWeapon = weapons.pistol;
        
        // 敌人数组
        let enemies = [];
        
        // 子弹数组
        let bullets = [];
        
        // 技能牌数组
        let skills = [];
        
        // 摇杆控制
        let joystick = {
            x: 0,
            y: 0,
            radius: 0,
            isDragging: false
        };
        
        // 射击计时器
        let lastShotTime = 0;
        
        // 获取DOM元素
        const canvas = document.getElementById('game-canvas');
        const ctx = canvas.getContext('2d');
        const startScreen = document.getElementById('start-screen');
        const gameScreen = document.getElementById('game-screen');
        const gameOverScreen = document.getElementById('game-over-screen');
        const gameOverCard = document.getElementById('game-over-card');
        const startGameBtn = document.getElementById('start-game-btn');
        const restartGameBtn = document.getElementById('restart-game-btn');
        const upgradeBtn = document.getElementById('upgrade-btn');
        const upgradeScreen = document.getElementById('upgrade-screen');
        const closeUpgradeBtn = document.getElementById('close-upgrade');
        const waveDisplay = document.getElementById('wave-display');
        const coinsDisplay = document.getElementById('coins-display');
        const weaponDisplay = document.getElementById('weapon-display');
        const weaponIcon = document.getElementById('weapon-icon');
        const weaponName = document.getElementById('weapon-name');
        const weaponLevel = document.getElementById('weapon-level');
        const skillBtns = document.querySelectorAll('.skill-btn');
        const weaponBtns = document.querySelectorAll('.weapon-btn');
        const finalWave = document.getElementById('final-wave');
        const finalScore = document.getElementById('final-score');
        const highScoreDisplay = document.getElementById('high-score');
        const currentCoins = document.getElementById('current-coins');
        const currentWeaponLevel = document.getElementById('current-weapon-level');
        const currentSkillLevel = document.getElementById('current-skill-level');
        const currentCharacterLevel = document.getElementById('current-character-level');
        const weaponUpgradeCost = document.getElementById('weapon-upgrade-cost');
        const skillUpgradeCost = document.getElementById('skill-upgrade-cost');
        const characterUpgradeCost = document.getElementById('character-upgrade-cost');
        const upgradeWeaponBtn = document.getElementById('upgrade-weapon');
        const upgradeSkillBtn = document.getElementById('upgrade-skill');
        const upgradeCharacterBtn = document.getElementById('upgrade-character');
        
        // 设置画布尺寸
        canvas.width = GAME_WIDTH;
        canvas.height = GAME_HEIGHT;
        
        // 技能类型
        const SKILL_TYPES = {
            speed: { name: "加速", icon: "fa-bolt", unicode: "\uf0e7", color: "#F59E0B", tailwindColor: "text-yellow-400", effect: (char) => { char.speed = char.speed * 2; }, duration: 5000 },
            heal: { name: "治疗", icon: "fa-heart", unicode: "\uf004", color: "#10B981", tailwindColor: "text-green-400", effect: (char) => { char.health = Math.min(char.health + 30, char.maxHealth); }, duration: 0 },
            damage: { name: "伤害提升", icon: "fa-bomb", unicode: "\uf1e2", color: "#EF4444", tailwindColor: "text-red-400", effect: (char) => { currentWeapon.damage = currentWeapon.damage * 1.5; }, duration: 5000 },
            shield: { name: "护盾", icon: "fa-shield-alt", unicode: "\uf3ed", color: "#3B82F6", tailwindColor: "text-blue-400", effect: (char) => { char.health = char.maxHealth; char.shield = true; }, duration: 3000 }
        };
        
        // 技能冷却时间
        let activeSkills = [];
        
        // 游戏循环
        function gameLoop(timestamp) {
            if (gameState === 'playing' && !isPaused) {
                // 清除画布
                ctx.clearRect(0, 0, GAME_WIDTH, GAME_HEIGHT);
                
                // 绘制背景
                drawBackground();
                
                // 更新和绘制角色
                updateCharacter(timestamp);
                drawCharacter();
                
                // 更新和绘制敌人
                updateEnemies(timestamp);
                drawEnemies();
                
                // 更新和绘制子弹
                updateBullets(timestamp);
                drawBullets();
                
                // 更新和绘制技能牌
                updateSkills(timestamp);
                drawSkills();
                
                // 更新技能冷却
                updateSkillCooldowns(timestamp);
                
                // 检查游戏结束
                checkGameOver();
                
                // 更新UI
                updateUI();
            }
            
            // 继续游戏循环
            requestAnimationFrame(gameLoop);
        }
        
        // 绘制背景
        function drawBackground() {
            // 渐变背景
            const gradient = ctx.createLinearGradient(0, 0, 0, GAME_HEIGHT);
            gradient.addColorStop(0, '#1E293B');
            gradient.addColorStop(1, '#0F172A');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, GAME_WIDTH, GAME_HEIGHT);
            
            // 绘制网格背景
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.05)';
            ctx.lineWidth = 1;
            
            const gridSize = 50;
            for (let x = 0; x < GAME_WIDTH; x += gridSize) {
                ctx.beginPath();
                ctx.moveTo(x, 0);
                ctx.lineTo(x, GAME_HEIGHT);
                ctx.stroke();
            }
            
            for (let y = 0; y < GAME_HEIGHT; y += gridSize) {
                ctx.beginPath();
                ctx.moveTo(0, y);
                ctx.lineTo(GAME_WIDTH, y);
                ctx.stroke();
            }
        }
        
        // 更新角色状态
        function updateCharacter(timestamp) {
            // 根据摇杆方向移动角色
            const moveX = character.speed * character.direction.x;
            const moveY = character.speed * character.direction.y;
            
            character.x += moveX;
            character.y += moveY;
            
            // 边界检测
            if (character.x < character.width / 2) character.x = character.width / 2;
            if (character.x > GAME_WIDTH - character.width / 2) character.x = GAME_WIDTH - character.width / 2;
            if (character.y < character.height / 2) character.y = character.height / 2;
            if (character.y > GAME_HEIGHT - character.height / 2) character.y = GAME_HEIGHT - character.height / 2;
            
            // 射击逻辑
            if (character.canShoot && timestamp - lastShotTime > currentWeapon.fireRate / character.weaponLevel) {
                shoot();
                lastShotTime = timestamp;
            }
            
            // 应用技能效果
            activeSkills = activeSkills.filter(skill => {
                if (skill.expireTime > timestamp) {
                    return true;
                } else {
                    // 技能效果过期，恢复原始属性
                    if (skill.type === 'speed') {
                        character.speed = 5 * (1 + (character.characterLevel - 1) * 0.1);
                    } else if (skill.type === 'damage') {
                        currentWeapon.damage = weapons[character.weapon].upgradeDamage[character.weaponLevel - 1];
                    } else if (skill.type === 'shield') {
                        character.shield = false;
                    }
                    return false;
                }
            });
        }
        
        // 绘制角色
        function drawCharacter() {
            // 角色主体
            ctx.fillStyle = '#3B82F6';
            ctx.beginPath();
            ctx.arc(character.x, character.y, character.width / 2, 0, Math.PI * 2);
            ctx.fill();
            
            // 角色眼睛
            ctx.fillStyle = 'white';
            ctx.beginPath();
            ctx.arc(character.x - character.width * 0.2, character.y - character.width * 0.3, character.width * 0.1, 0, Math.PI * 2);
            ctx.arc(character.x + character.width * 0.2, character.y - character.width * 0.3, character.width * 0.1, 0, Math.PI * 2);
            ctx.fill();
            
            ctx.fillStyle = 'black';
            ctx.beginPath();
            ctx.arc(character.x - character.width * 0.15, character.y - character.width * 0.35, character.width * 0.05, 0, Math.PI * 2);
            ctx.arc(character.x + character.width * 0.25, character.y - character.width * 0.35, character.width * 0.05, 0, Math.PI * 2);
            ctx.fill();
            
            // 武器绘制
            ctx.fillStyle = currentWeapon.bulletColor;
            const weaponLength = character.width * 0.6;
            const weaponAngle = Math.atan2(character.direction.y, character.direction.x) || 0;
            
            ctx.beginPath();
            ctx.moveTo(character.x, character.y);
            ctx.lineTo(
                character.x + Math.cos(weaponAngle) * weaponLength,
                character.y + Math.sin(weaponAngle) * weaponLength
            );
            ctx.lineWidth = character.width * 0.1;
            ctx.stroke();
            
            // 生命值条
            drawHealthBar(character.x - character.width / 2, character.y - character.height / 2 - character.width / 2, character.width, 5, character.health, character.maxHealth);
            
            // 护盾效果
            if (character.shield) {
                ctx.strokeStyle = 'rgba(59, 130, 246, 0.5)';
                ctx.lineWidth = 3;
                ctx.beginPath();
                ctx.arc(character.x, character.y, character.width / 2 + 5, 0, Math.PI * 2);
                ctx.stroke();
            }
        }
        
        // 绘制生命值条
        function drawHealthBar(x, y, width, height, current, max) {
            // 背景
            ctx.fillStyle = 'rgba(0, 0, 0, 0.5)';
            ctx.fillRect(x, y, width, height);
            
            // 生命值
            const percent = current / max;
            ctx.fillStyle = percent > 0.5 ? '#10B981' : percent > 0.2 ? '#F59E0B' : '#EF4444';
            ctx.fillRect(x, y, width * percent, height);
        }
        
        // 生成敌人
        function spawnEnemies() {
            // 每波敌人数量随波次增加
            const enemiesPerWave = currentWave * 2 + 3;
            
            for (let i = 0; i < enemiesPerWave; i++) {
                const size = ENEMY_MIN_SIZE + Math.random() * (ENEMY_MAX_SIZE - ENEMY_MIN_SIZE);
                const x = Math.random() * (GAME_WIDTH - size) + size / 2;
                const y = Math.random() * (GAME_HEIGHT - size) + size / 2;
                
                // 确保敌人不会生成在角色附近
                const distanceFromCharacter = Math.sqrt(
                    (x - character.x) * (x - character.x) + 
                    (y - character.y) * (y - character.y)
                );
                
                if (distanceFromCharacter > GAME_WIDTH * 0.3) {
                    enemies.push({
                        x,
                        y,
                        width: size,
                        height: size,
                        health: 10 + currentWave * 5, // 敌人生命值随波次增加
                        maxHealth: 10 + currentWave * 5,
                        speed: 2 + currentWave * 0.2, // 敌人速度随波次增加
                        color: getRandomEnemyColor(),
                        targetX: character.x,
                        targetY: character.y
                    });
                }
            }
        }
        
        // 更新敌人状态
        function updateEnemies(timestamp) {
            // 每波次开始时生成敌人
            if (enemies.length === 0 && gameState === 'playing') {
                currentWave++;
                spawnEnemies();
            }
            
            // 移动敌人并更新目标
            for (let i = enemies.length - 1; i >= 0; i--) {
                const enemy = enemies[i];
                enemy.targetX = character.x;
                enemy.targetY = character.y;
                
                // 计算敌人到角色的距离和方向
                const dx = enemy.targetX - enemy.x;
                const dy = enemy.targetY - enemy.y;
                const distance = Math.sqrt(dx * dx + dy * dy);
                
                if (distance > 0) {
                    enemy.x += (dx / distance) * enemy.speed;
                    enemy.y += (dy / distance) * enemy.speed;
                }
                
                // 检测敌人与角色的碰撞
                if (checkCollision(character, enemy)) {
                    // 角色受到伤害
                    if (!character.shield) {
                        character.health -= 5;
                        if (character.health <= 0) {
                            character.health = 0;
                        }
                    }
                    
                    // 敌人击退效果
                    const knockback = 20;
                    enemy.x += (dx / distance) * knockback;
                    enemy.y += (dy / distance) * knockback;
                }
                
                // 移除死亡的敌人
                if (enemy.health <= 0) {
                    // 增加分数和金币
                    score += 10 + currentWave * 5;
                    coins += 5 + currentWave;
                    
                    // 随机掉落技能牌
                    if (Math.random() < 0.3) {
                        spawnSkill(enemy.x, enemy.y);
                    }
                    
                    enemies.splice(i, 1);
                }
            }
        }
        
        // 绘制敌人
        function drawEnemies() {
            enemies.forEach(enemy => {
                // 敌人主体
                ctx.fillStyle = enemy.color;
                ctx.beginPath();
                ctx.arc(enemy.x, enemy.y, enemy.width / 2, 0, Math.PI * 2);
                ctx.fill();
                
                // 敌人眼睛
                ctx.fillStyle = 'black';
                ctx.beginPath();
                ctx.arc(enemy.x - enemy.width * 0.2, enemy.y - enemy.width * 0.3, enemy.width * 0.1, 0, Math.PI * 2);
                ctx.arc(enemy.x + enemy.width * 0.2, enemy.y - enemy.width * 0.3, enemy.width * 0.1, 0, Math.PI * 2);
                ctx.fill();
                
                // 敌人生命值条
                drawHealthBar(
                    enemy.x - enemy.width / 2, 
                    enemy.y - enemy.height / 2 - enemy.width / 2, 
                    enemy.width, 
                    3, 
                    enemy.health, 
                    enemy.maxHealth
                );
            });
        }
        
        // 射击
        function shoot() {
            const weapon = currentWeapon;
            const angle = Math.atan2(character.direction.y, character.direction.x) || 0;
            
            bullets.push({
                x: character.x + Math.cos(angle) * (character.width / 2 + 10),
                y: character.y + Math.sin(angle) * (character.width / 2 + 10),
                width: BULLET_SIZE,
                height: BULLET_SIZE,
                speed: weapon.bulletSpeed,
                damage: weapon.damage,
                angle,
                color: weapon.bulletColor
            });
        }
        
        // 更新子弹
        function updateBullets(timestamp) {
            for (let i = bullets.length - 1; i >= 0; i--) {
                const bullet = bullets[i];
                bullet.x += Math.cos(bullet.angle) * bullet.speed;
                bullet.y += Math.sin(bullet.angle) * bullet.speed;
                
                // 检测子弹与敌人的碰撞
                for (let j = enemies.length - 1; j >= 0; j--) {
                    const enemy = enemies[j];
                    if (checkCollision(bullet, enemy)) {
                        enemy.health -= bullet.damage;
                        bullets.splice(i, 1);
                        break;
                    }
                }
                
                // 移除超出屏幕的子弹
                if (
                    bullet.x < -BULLET_SIZE || 
                    bullet.x > GAME_WIDTH + BULLET_SIZE || 
                    bullet.y < -BULLET_SIZE || 
                    bullet.y > GAME_HEIGHT + BULLET_SIZE
                ) {
                    bullets.splice(i, 1);
                }
            }
        }
        
        // 绘制子弹
        function drawBullets() {
            bullets.forEach(bullet => {
                ctx.fillStyle = bullet.color;
                ctx.beginPath();
                ctx.arc(bullet.x, bullet.y, bullet.width / 2, 0, Math.PI * 2);
                ctx.fill();
            });
        }
        
        // 生成技能牌
        function spawnSkill(x, y) {
            const skillTypes = Object.keys(SKILL_TYPES);
            const randomSkill = skillTypes[Math.floor(Math.random() * skillTypes.length)];
            
            skills.push({
                x,
                y,
                width: SKILL_SIZE,
                height: SKILL_SIZE,
                type: randomSkill,
                color: SKILL_TYPES[randomSkill].color,
                collected: false
            });
        }
        
        // 更新技能牌
        function updateSkills(timestamp) {
            for (let i = skills.length - 1; i >= 0; i--) {
                const skill = skills[i];
                
                // 检测是否被收集
                if (checkCollision(character, skill) && !skill.collected) {
                    skill.collected = true;
                    activateSkill(skill.type);
                    skills.splice(i, 1);
                    continue;
                }
                
                // 技能牌闪烁效果
                const flash = Math.sin(timestamp / 1000) * 50 + 200;
                ctx.fillStyle = `rgba(${parseInt(skill.color.replace(/#/, '').substring(0, 2), 16)}, ${parseInt(skill.color.replace(/#/, '').substring(2, 4), 16)}, ${parseInt(skill.color.replace(/#/, '').substring(4, 6), 16)}, ${flash/255})`;
            }
        }
        
        // 绘制技能牌
        function drawSkills() {
            skills.forEach(skill => {
                // 技能牌背景
                ctx.fillStyle = skill.color;
                ctx.beginPath();
                ctx.arc(skill.x, skill.y, skill.width / 2, 0, Math.PI * 2);
                ctx.fill();
                
                // 技能图标
                const unicode = SKILL_TYPES[skill.type].unicode;
                ctx.fillStyle = 'white';
                ctx.font = `900 ${skill.width * 0.6}px "Font Awesome 6 Free"`;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(unicode, skill.x, skill.y);
            });
        }
        
        // 激活技能
        function activateSkill(skillType) {
            const skill = SKILL_TYPES[skillType];
            skill.effect(character);
            
            if (skill.duration > 0) {
                activeSkills.push({
                    type: skillType,
                    expireTime: Date.now() + skill.duration,
                    originalSpeed: character.speed,
                    originalDamage: currentWeapon.damage
                });
            }
            
            // 播放技能效果
            canvas.classList.add('animate-pulse');
            setTimeout(() => {
                canvas.classList.remove('animate-pulse');
            }, 300);
        }
        
        // 更新技能冷却
        function updateSkillCooldowns(timestamp) {
            // 更新技能按钮冷却
            skillBtns.forEach(btn => {
                const skillType = btn.dataset.skill;
                const cooldown = character.skillCooldown[skillType];
                
                if (cooldown > timestamp) {
                    btn.classList.add('opacity-50', 'cursor-not-allowed');
                    btn.classList.remove('bg-dark/50');
                    btn.classList.add('bg-gray-700');
                    
                    const remaining = Math.max(0, cooldown - timestamp) / 1000;
                    btn.innerHTML = `<i class="fa-solid ${SKILL_TYPES[skillType].icon} text-2xl ${SKILL_TYPES[skillType].tailwindColor}"></i><span class="text-xs mt-1">${Math.ceil(remaining)}</span>`;
                } else {
                    btn.classList.remove('opacity-50', 'cursor-not-allowed', 'bg-gray-700');
                    btn.classList.add('bg-dark/50');
                    btn.innerHTML = `<i class="fa-solid ${SKILL_TYPES[skillType].icon} text-2xl ${SKILL_TYPES[skillType].tailwindColor}"></i>`;
                }
            });
        }
        
        // 检查碰撞
        function checkCollision(obj1, obj2) {
            const dx = obj1.x - obj2.x;
            const dy = obj1.y - obj2.y;
            const distance = Math.sqrt(dx * dx + dy * dy);
            return distance < (obj1.width + obj2.width) / 2;
        }
        
        // 检查游戏结束
        function checkGameOver() {
            if (character.health <= 0) {
                gameOver();
            }
        }
        
        // 游戏结束
        function gameOver() {
            gameState = 'gameOver';
            gameScreen.classList.add('hidden');
            gameOverScreen.classList.remove('hidden');
            
            // 更新最终得分和最高分
            finalWave.textContent = currentWave - 1;
            finalScore.textContent = score;
            
            if (score > highScore) {
                highScore = score;
                localStorage.setItem('adventureHighScore', highScore);
            }
            
            highScoreDisplay.textContent = highScore;
            
            // 显示游戏结束卡片的动画
            setTimeout(() => {
                gameOverCard.classList.remove('scale-95', 'opacity-0');
                gameOverCard.classList.add('scale-100', 'opacity-100');
            }, 100);
        }
        
        // 打开升级界面
        function openUpgradeScreen() {
            isPaused = true;
            gameState = 'upgrade';
            upgradeScreen.classList.remove('hidden');
            
            // 更新升级界面数据
            updateUpgradeUI();
        }
        
        // 关闭升级界面
        function closeUpgradeScreen() {
            isPaused = false;
            gameState = 'playing';
            upgradeScreen.classList.add('hidden');
        }
        
        // 更新升级界面UI
        function updateUpgradeUI() {
            currentCoins.textContent = coins;
            currentWeaponLevel.textContent = character.weaponLevel;
            currentSkillLevel.textContent = character.skillLevel;
            currentCharacterLevel.textContent = character.characterLevel;
            
            // 武器升级
            const weapon = weapons[character.weapon];
            weaponUpgradeCost.textContent = weapon.upgradeCost[character.weaponLevel] || "已max";
            upgradeWeaponBtn.disabled = 
                character.weaponLevel >= weapon.upgradeCost.length || 
                coins < weapon.upgradeCost[character.weaponLevel];
            
            // 技能升级
            const skillUpgradeCostValue = 30 * character.skillLevel;
            skillUpgradeCost.textContent = skillUpgradeCostValue;
            upgradeSkillBtn.disabled = 
                character.skillLevel >= 5 || 
                coins < skillUpgradeCostValue;
            
            // 角色升级
            const characterUpgradeCostValue = 40 * character.characterLevel;
            characterUpgradeCost.textContent = characterUpgradeCostValue;
            upgradeCharacterBtn.disabled = 
                character.characterLevel >= 5 || 
                coins < characterUpgradeCostValue;
        }
        
        // 升级武器
        function upgradeWeapon() {
            const weapon = weapons[character.weapon];
            if (character.weaponLevel < weapon.upgradeCost.length && coins >= weapon.upgradeCost[character.weaponLevel]) {
                coins -= weapon.upgradeCost[character.weaponLevel];
                character.weaponLevel++;
                currentWeapon.damage = weapon.upgradeDamage[character.weaponLevel - 1];
                currentWeapon.fireRate = weapon.upgradeFireRate[character.weaponLevel - 1];
                updateUpgradeUI();
                updateUI();
            }
        }
        
        // 升级技能
        function upgradeSkill() {
            if (character.skillLevel < 5 && coins >= 30 * character.skillLevel) {
                coins -= 30 * character.skillLevel;
                character.skillLevel++;
                updateUpgradeUI();
            }
        }
        
        // 升级角色
        function upgradeCharacter() {
            if (character.characterLevel < 5 && coins >= 40 * character.characterLevel) {
                coins -= 40 * character.characterLevel;
                character.characterLevel++;
                character.maxHealth = 100 + (character.characterLevel - 1) * 20;
                character.health = character.maxHealth;
                character.speed = 5 + (character.characterLevel - 1) * 0.5;
                updateUpgradeUI();
            }
        }
        
        // 更新UI
        function updateUI() {
            waveDisplay.textContent = `波次: ${currentWave}`;
            coinsDisplay.textContent = `金币: ${coins}`;
            weaponName.textContent = currentWeapon.name;
            weaponLevel.textContent = `LV.${character.weaponLevel}`;
            weaponIcon.className = `fa-solid ${currentWeapon.icon} text-2xl ${currentWeapon.bulletColor}`;
            
            // 更新武器按钮状态
            weaponBtns.forEach(btn => {
                const weaponType = btn.dataset.weapon;
                const weapon = weapons[weaponType];
                
                btn.classList.remove('border-primary', 'bg-primary/20');
                btn.classList.add('border-transparent');
                
                if (weapon.isUnlocked) {
                    if (weaponType === character.weapon) {
                        btn.classList.add('border-primary', 'bg-primary/20');
                    }
                } else {
                    btn.classList.add('opacity-50', 'cursor-not-allowed');
                    if (coins >= weapon.unlockCost) {
                        btn.classList.remove('opacity-50', 'cursor-not-allowed');
                        btn.classList.add('hover:border-primary', 'hover:bg-primary/10');
                    }
                }
            });
        }
        
        // 切换武器
        function switchWeapon(weaponType) {
            const weapon = weapons[weaponType];
            if (weapon.isUnlocked || coins >= weapon.unlockCost) {
                if (!weapon.isUnlocked) {
                    coins -= weapon.unlockCost;
                    weapon.isUnlocked = true;
                }
                
                character.weapon = weaponType;
                currentWeapon = weapon;
                updateUI();
            }
        }
        
        // 重置游戏
        function resetGame() {
            gameState = 'playing';
            currentWave = 1;
            score = 0;
            coins = 0;
            character = {
                x: GAME_WIDTH / 2,
                y: GAME_HEIGHT / 2,
                width: CHARACTER_SIZE,
                height: CHARACTER_SIZE,
                speed: 5,
                health: 100,
                maxHealth: 100,
                direction: { x: 0, y: 0 },
                weapon: 'pistol',
                weaponLevel: 1,
                skillCooldown: {
                    speed: 0,
                    heal: 0
                },
                skillLevel: 1,
                characterLevel: 1,
                canShoot: true,
                shield: false
            };
            
            currentWeapon = weapons.pistol;
            enemies = [];
            bullets = [];
            skills = [];
            activeSkills = [];
            joystick = { x: 0, y: 0, radius: 0, isDragging: false };
            lastShotTime = 0;
            
            // 重置武器解锁状态
            for (const weaponType in weapons) {
                if (weaponType === 'pistol') {
                    weapons[weaponType].isUnlocked = true;
                } else {
                    weapons[weaponType].isUnlocked = false;
                }
            }
            
            // 更新UI
            updateUI();
            updateUpgradeUI();
            
            // 隐藏所有界面，显示游戏界面
            startScreen.classList.add('hidden');
            gameOverScreen.classList.add('hidden');
            upgradeScreen.classList.add('hidden');
            gameScreen.classList.remove('hidden');
        }
        
        // 启动游戏
        function startGame() {
            resetGame();
            startScreen.classList.add('opacity-0');
            setTimeout(() => {
                startScreen.classList.add('hidden');
            }, 500);
        }
        
        // 触摸控制 - 虚拟摇杆
        function setupJoystick() {
            const joystickContainer = document.getElementById('joystick-container');
            const joystick = document.getElementById('joystick-dot');
            
            let startX, startY;
            
            joystickContainer.addEventListener('touchstart', (e) => {
                if (gameState === 'playing') {
                    startX = e.touches[0].clientX;
                    startY = e.touches[0].clientY;
                    joystick.isDragging = true;
                }
            });
            
            document.addEventListener('touchmove', (e) => {
                if (joystick.isDragging) {
                    const touchX = e.touches[0].clientX;
                    const touchY = e.touches[0].clientY;
                    const containerRect = joystickContainer.getBoundingClientRect();
                    const containerX = containerRect.left;
                    const containerY = containerRect.top;
                    const containerWidth = containerRect.width;
                    const containerHeight = containerRect.height;
                    
                    // 计算触摸点相对于摇杆容器的位置
                    const x = touchX - containerX;
                    const y = touchY - containerY;
                    
                    // 限制在容器内
                    let dx = x - containerWidth / 2;
                    let dy = y - containerHeight / 2;
                    const radius = Math.sqrt(dx * dx + dy * dy);
                    
                    // 限制摇杆移动范围
                    if (radius > containerWidth / 2) {
                        dx = (dx / radius) * (containerWidth / 2);
                        dy = (dy / radius) * (containerWidth / 2);
                    }
                    
                    // 更新摇杆位置
                    joystick.style.transform = `translate(${dx}px, ${dy}px)`;
                    
                    // 计算方向
                    character.direction.x = dx / (containerWidth / 2);
                    character.direction.y = dy / (containerHeight / 2);
                }
            });
            
            document.addEventListener('touchend', () => {
                joystick.isDragging = false;
                joystick.style.transform = 'translate(0, 0)';
                character.direction.x = 0;
                character.direction.y = 0;
            });
        }
        
        // 技能按钮点击事件
        function setupSkillButtons() {
            skillBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    if (gameState === 'playing' && !isPaused) {
                        const skillType = btn.dataset.skill;
                        const currentTime = Date.now();
                        
                        if (character.skillCooldown[skillType] <= currentTime) {
                            // 激活技能
                            activateSkill(skillType);
                            
                            // 设置冷却时间
                            const cooldown = 10000 / character.skillLevel; // 技能冷却时间随技能等级减少
                            character.skillCooldown[skillType] = currentTime + cooldown;
                        }
                    }
                });
            });
        }
        
        // 武器按钮点击事件
        function setupWeaponButtons() {
            weaponBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    if (gameState === 'start') {
                        const weaponType = btn.dataset.weapon;
                        character.weapon = weaponType;
                        currentWeapon = weapons[weaponType];
                        
                        // 更新UI
                        weaponBtns.forEach(b => {
                            b.classList.remove('border-primary', 'bg-primary/20');
                            b.classList.add('border-transparent');
                        });
                        
                        btn.classList.add('border-primary', 'bg-primary/20');
                    } else if (gameState === 'playing' && !isPaused) {
                        const weaponType = btn.dataset.weapon;
                        switchWeapon(weaponType);
                    }
                });
            });
        }
        
        // 事件监听
        function setupEventListeners() {
            startGameBtn.addEventListener('click', startGame);
            restartGameBtn.addEventListener('click', resetGame);
            upgradeBtn.addEventListener('click', openUpgradeScreen);
            closeUpgradeBtn.addEventListener('click', closeUpgradeScreen);
            upgradeWeaponBtn.addEventListener('click', upgradeWeapon);
            upgradeSkillBtn.addEventListener('click', upgradeSkill);
            upgradeCharacterBtn.addEventListener('click', upgradeCharacter);
            
            // 触摸控制
            setupJoystick();
            
            // 技能按钮
            setupSkillButtons();
            
            // 武器按钮
            setupWeaponButtons();
        }
        
        // 响应式处理
        function handleResize() {
            const newWidth = window.innerWidth;
            const newHeight = window.innerHeight;
            
            canvas.width = newWidth;
            canvas.height = newHeight;
            
            // 更新游戏常量
            const oldWidth = GAME_WIDTH;
            const oldHeight = GAME_HEIGHT;
            const widthRatio = newWidth / oldWidth;
            const heightRatio = newHeight / oldHeight;
            
            // 保持角色大小相对不变
            character.width = Math.min(newWidth * 0.08, 60);
            character.height = character.width;
            character.x = newWidth / 2;
            character.y = newHeight / 2;
            
            // 更新其他游戏元素大小
            ENEMY_MIN_SIZE = Math.min(newWidth * 0.06, 40);
            ENEMY_MAX_SIZE = Math.min(newWidth * 0.1, 60);
            SKILL_SIZE = Math.min(newWidth * 0.07, 50);
            BULLET_SIZE = Math.min(newWidth * 0.03, 20);
            
            // 更新武器数据（保持相对大小）
            for (const weaponType in weapons) {
                const weapon = weapons[weaponType];
                weapon.bulletSpeed = weapons[weaponType].bulletSpeed * widthRatio;
            }
        }
        
        // 初始化游戏
        function init() {
            setupEventListeners();
            window.addEventListener('resize', handleResize);
            gameLoop(0);
        }
        
        // 启动游戏
        init();
    </script>
</body>
</html>
